---
- hosts: sonarqube-server
  become: true
  tasks:
    - name: create sonarqube user
      user:
        name: "sonarqube"
        password: "Sonarqube123$"
        state: present
        
    - name: install pre-requisites (unzip, java 17, wget
       yum:
         name: 
           - java-17-openjdk
           - unzip
           - wget
         state: present

    - name: download sonarqube
      get_url:
        url: https://binaries.sonarsource.com/Distribution/sonarqube/sonarqube-10.5.1.90531.zip
        dest: /opt

    - name: extract maven packages
      unarchive:
        src: /opt/sonarqube-10.5.1.90531.zip
        dest: /opt
        remote_src: yes
     
    - name: change sonarqube directory ownership and permissions
      command: chmod -R 775 /opt/sonarqube-10.5.1.90531
      command: chown -R sonarqube:sonarqube /opt/sonarqube-10.5.1.90531

    - name: Create a systemd service for SonarQube
      template:
        src: sonarqube.service.txt
        dest: /etc/systemd/system/sonarqube.service
      notify:
        - Restart Sonarqube
  handlers:
    - name: Restart sonarqube
